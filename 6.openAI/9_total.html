<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGE-M3 RAG í†µí•© ìš”ì•½ ë° í‰ê°€</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            color: #2c3e50;
            line-height: 1.6;
            padding: 20px;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        h1 {
            color: #e67e22;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #f39c12;
            padding-bottom: 10px;
            font-size: 2.5em;
        }
        h2 {
            color: #2980b9;
            margin-top: 40px;
            margin-bottom: 20px;
            border-left: 6px solid #3498db;
            padding-left: 15px;
            font-size: 1.8em;
        }
        h3 {
            color: #34495e;
            margin-top: 25px;
            font-size: 1.4em;
            border-bottom: 1px dashed #bdc3c7;
            padding-bottom: 5px;
        }
        p {
            margin-bottom: 15px;
            color: #495057;
        }
        
        /* ì´ë¯¸ì§€ ì˜ì—­ */
        .system-image {
            text-align: center;
            margin: 30px 0;
        }
        .system-image img {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        /* ì½”ë“œ ë¸”ë¡ ìŠ¤íƒ€ì¼ */
        pre {
            background-color: #2d2d2d;
            color: #ccc;
            padding: 18px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.88em;
            line-height: 1.5;
            margin-top: 15px;
        }
        .keyword { color: #cc7832; }
        .function { color: #61afef; }
        .string { color: #a9b7c6; }
        .comment { color: #75715e; }
        .variable { color: #e6c07b; }
        .number { color: #ae81ff; }

        /* íŠ¹ì§• ë¦¬ìŠ¤íŠ¸ */
        .feature-list {
            list-style-type: none;
            padding-left: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .feature-list li {
            background: #fdfefe;
            border-left: 4px solid #2ecc71;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .feature-list strong {
            color: #27ae60;
        }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #fdfdfd;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
        }
        th {
            background-color: #f1f1f1;
            color: #34495e;
            font-weight: bold;
        }
        /* êµ¬ì¡° ì„¹ì…˜ ê°•ì¡° */
        .structure-summary {
            background-color: #e9f5ff;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #3498db;
        }
        .structure-summary h2 {
            border-left: none;
            padding-left: 0;
            color: #2980b9;
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="structure-summary">
            <h2>ğŸ“œ ë¬¸ì„œ êµ¬ì¡° ë° í•™ìŠµ íë¦„ ë„ì‹í™”</h2>
            <p>ì´ ìš”ì•½ ë¬¸ì„œëŠ” BGE-M3 ëª¨ë¸ì„ ê¸°ë°˜ìœ¼ë¡œ RAG ì‹œìŠ¤í…œì„ **ì´ë¡ -êµ¬ì¶•-í‰ê°€**ì˜ ë…¼ë¦¬ì  íë¦„ì— ë”°ë¼ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤. ê° ì„¹ì…˜ì€ ì‚¬ìš©ìë‹˜ì´ ì œê³µí•˜ì‹  ì£¼í”¼í„° ë…¸íŠ¸ë¶ íŒŒì¼ë“¤ì˜ ë‚´ìš©ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.</p>

            <h3>ë…¼ë¦¬ì  íë¦„ë„</h3>
            <div class="system-image">
                
            </div>

            <h3>ì„¹ì…˜ë³„ ë‚´ìš© ìš”ì•½í‘œ</h3>
            <table>
                <thead>
                    <tr>
                        <th>HTML ì„¹ì…˜</th>
                        <th>í¬í•¨ëœ íŒŒì¼</th>
                        <th>í•µì‹¬ ë‚´ìš©</th>
                        <th>ì£¼ìš” ëª©ì </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>**1. BGE-M3 í•˜ì´ë¸Œë¦¬ë“œ ì„ë² ë”©**</td>
                        <td>`9_1.BGEM3.ipynb`</td>
                        <td>BGE-M3ì˜ **ë‹¤êµ­ì–´, í•˜ì´ë¸Œë¦¬ë“œ ë²¡í„°(Dense/Sparse)** íŠ¹ì§• ë° ë²¡í„° ìƒì„± ì½”ë“œ</td>
                        <td>RAG ì„±ëŠ¥ì˜ ê·¼ê°„ì´ ë˜ëŠ” ëª¨ë¸ì˜ **ëŠ¥ë ¥ ì •ì˜**</td>
                    </tr>
                    <tr>
                        <td>**2. RAG íŒŒì´í”„ë¼ì¸ êµ¬ì¶• ë‹¨ê³„**</td>
                        <td>`9_3.ipynb`</td>
                        <td>**ë¬¸ì„œ ë¶„í• (Chunking)** ì½”ë“œ ë° BGE-M3ë¥¼ ì´ìš©í•œ **VectorDB êµ¬ì¶• ë° ê²€ìƒ‰ í…ŒìŠ¤íŠ¸** ì½”ë“œ</td>
                        <td>ì‹¤ì œ RAG ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ëŠ” **ì‹¤í–‰ ê³¼ì •** ì‹œì—°</td>
                    </tr>
                    <tr>
                        <td>**3. ì„ë² ë”© ëª¨ë¸ í’ˆì§ˆ í‰ê°€**</td>
                        <td>`9_2.ipynb`</td>
                        <td>ì„ë² ë”© ëª¨ë¸ì˜ ì„±ëŠ¥ì„ ê²€ì¦í•˜ëŠ” **í‰ê°€ ë¡œì§** (ì¿¼ë¦¬ vs ê´€ë ¨/ë¹„ê´€ë ¨ ë¬¸ì„œ ìœ ì‚¬ë„ ë¹„êµ) ë° ì½”ë“œ êµ¬ì¡°</td>
                        <td>ëª¨ë¸ì˜ **ì‹¤ì œ ì •í™•ë„ ê²€ì¦** ë° ì„±ëŠ¥ í•´ì„</td>
                    </tr>
                </tbody>
            </table>
            <p style="font-size: 0.9em; color: #6c757d; margin-top: 15px; text-align: center;">
                *ìŠ¤í¬ë¡¤ì„ ë‚´ë ¤ ê° ë‹¨ê³„ë³„ ìƒì„¸ ì„¤ëª…ê³¼ ì£¼ìš” ì½”ë“œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.*
            </p>
        </div>
        
        <hr>

        <h1>ğŸ” BGE-M3 ëª¨ë¸ ê¸°ë°˜ RAG ì‹œìŠ¤í…œ í†µí•© ë¶„ì„</h1>
        <p>BGE-M3ëŠ” RAGì˜ í•µì‹¬ì¸ ì„ë² ë”©(ë¬¸ì„œ ë²¡í„°í™”) ì„±ëŠ¥ì„ ë¹„ì•½ì ìœ¼ë¡œ í–¥ìƒì‹œí‚¤ëŠ” ëª¨ë¸ì…ë‹ˆë‹¤. ì•„ë˜ì—ì„œ ëª¨ë¸ì˜ íŠ¹ì§•, êµ¬ì¶• ë‹¨ê³„, ê·¸ë¦¬ê³  í’ˆì§ˆ í‰ê°€ ë°©ë²•ì„ ìƒì„¸íˆ ì •ë¦¬í•©ë‹ˆë‹¤.</p>

        <h2>1. ğŸ”‘ í•µì‹¬ ê¸°ìˆ : BGE-M3 í•˜ì´ë¸Œë¦¬ë“œ ì„ë² ë”©</h2>
        <p>BGE-M3ëŠ” í•˜ë‚˜ì˜ ëª¨ë¸ë¡œ ì—¬ëŸ¬ ê²€ìƒ‰ ë°©ì‹ì„ ì§€ì›í•˜ëŠ” ê²ƒì´ íŠ¹ì§•ì…ë‹ˆë‹¤. ì´ëŠ” ê²€ìƒ‰ ëˆ„ë½ì„ ìµœì†Œí™”í•˜ê³  RAGì˜ ì •í™•ë„ë¥¼ ë†’ì´ëŠ” í•µì‹¬ ë™ë ¥ì…ë‹ˆë‹¤.</p>

        <h3>BGE-M3ì˜ ì£¼ìš” ëŠ¥ë ¥</h3>
        <ul class="feature-list">
            <li><strong>ë‹¤êµ­ì–´ (Multilingual):</strong> 100ê°œ ì´ìƒì˜ ì–¸ì–´ ì§€ì› (í•œêµ­ì–´ í¬í•¨), ë‹¤ì–‘í•œ ì¶œì²˜ì˜ ë¬¸ì„œ ì²˜ë¦¬ ê°€ëŠ¥.</li>
            <li><strong>í•˜ì´ë¸Œë¦¬ë“œ ë²¡í„° (Dense + Sparse):</strong> ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰(Dense)ê³¼ í‚¤ì›Œë“œ ë§¤ì¹­ ê²€ìƒ‰(Sparse)ì„ ë™ì‹œì— ìˆ˜í–‰.</li>
            <li><strong>ê¸´ ì»¨í…ìŠ¤íŠ¸:</strong> ìµœëŒ€ **8192 í† í°**ê¹Œì§€ ì²˜ë¦¬ ê°€ëŠ¥í•˜ì—¬ ê¸´ ë¬¸ì„œë„ íš¨ê³¼ì ìœ¼ë¡œ ì„ë² ë”©.</li>
        </ul>

        <h3>BGE-M3 ëª¨ë¸ ë¡œë“œ ë° ë²¡í„° ìƒì„± ì½”ë“œ</h3>
        <p>FlagEmbedding ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë¸ì„ ë¡œë“œí•˜ê³ , `return_dense`ì™€ `return_sparse` ì˜µì…˜ì„ í†µí•´ í•˜ì´ë¸Œë¦¬ë“œ ë²¡í„°ë¥¼ ìƒì„±í•˜ëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤.</p>
        <pre>
<span class="keyword">from</span> <span class="variable">FlagEmbedding</span> <span class="keyword">import</span> <span class="function">BGEM3FlagModel</span>

<span class="comment"># BGE-M3 ëª¨ë¸ ë¡œë“œ (HuggingFace, ë©”ëª¨ë¦¬ íš¨ìœ¨ì„ ìœ„í•´ fp16 ì‚¬ìš©)</span>
<span class="variable">model</span> = <span class="function">BGEM3FlagModel</span>(<span class="string">'BAAI/bge-m3'</span>, <span class="variable">use_fp16</span>=<span class="keyword">True</span>)

<span class="comment"># ì…ë ¥ ë¬¸ì¥ë“¤</span>
<span class="variable">sentences</span> = [<span class="string">"ì¸ê³µì§€ëŠ¥ íŠ¸ë Œë“œëŠ” ë¬´ì—‡ì¸ê°€ìš”?"</span>, <span class="string">"ì„ë² ë”© ëª¨ë¸ ë¹„êµ í…ŒìŠ¤íŠ¸"</span>]

<span class="comment"># Denseì™€ Sparse ë²¡í„°ë¥¼ ëª¨ë‘ ë°˜í™˜í•˜ë„ë¡ ì¸ì½”ë”©</span>
<span class="variable">output</span> = <span class="variable">model</span>.<span class="function">encode</span>(
    <span class="variable">sentences</span>, 
    <span class="variable">return_dense</span>=<span class="keyword">True</span>, 
    <span class="variable">return_sparse</span>=<span class="keyword">True</span>
)

<span class="comment"># ê²°ê³¼ í™•ì¸: dense_vecs (1024ì°¨ì›)ì™€ sparse_vecs (í† í°ID/ê°’ ìŒ) í¬í•¨</span>
<span class="function">print</span>(f<span class="string">'Dense ë²¡í„° ì°¨ì›: {output["dense_vecs"].shape[1]}'</span>) <span class="comment"># ë³´í†µ 1024</span>
        </pre>

        <h2>2. ğŸ—ï¸ RAG íŒŒì´í”„ë¼ì¸ êµ¬ì¶• ë‹¨ê³„</h2>
        <p>ì‹¤ì œ RAG ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ê¸° ìœ„í•´ ë¬¸ì„œë¥¼ ì„ë² ë”©í•˜ê³  VectorDBë¥¼ ë§Œë“œëŠ” ê³¼ì •ì„ ì •ë¦¬í•©ë‹ˆë‹¤. (íŒŒì¼ 9_3 ë‚´ìš©)</p>

        <h3>2-1. ë¬¸ì„œ ë¶„í•  (Chunking)</h3>
        <p>ê¸´ ë¬¸ì„œë¥¼ RAGì— ì í•©í•œ ì‘ì€ ì¡°ê°(Chunk)ìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ê³¼ì •ì…ë‹ˆë‹¤. ê²€ìƒ‰ì˜ ì •ë°€ë„ë¥¼ ë†’ì´ëŠ” ë° í•„ìˆ˜ì ì…ë‹ˆë‹¤.</p>
        <pre>
<span class="keyword">from</span> <span class="variable">langchain_text_splitters</span> <span class="keyword">import</span> <span class="function">RecursiveCharacterTextSplitter</span>

<span class="variable">text_spliter</span> = <span class="function">RecursiveCharacterTextSplitter</span>(
    <span class="variable">chunk_size</span>=<span class="number">300</span>, <span class="comment"># ì²­í¬ í¬ê¸° 300ì</span>
    <span class="variable">chunk_overlap</span>=<span class="number">50</span>  <span class="comment"># ì²­í¬ ê°„ ì¤‘ë³µ 50ì (ë¬¸ë§¥ ìœ ì§€ë¥¼ ìœ„í•¨)</span>
)

<span class="comment"># ë¬¸ì„œë“¤ì„ ì²­í¬ë¡œ ë¶„í• </span>
<span class="variable">doc_chunks</span> = <span class="variable">text_spliter</span>.<span class="function">split_documents</span>(<span class="variable">korean_documents</span>)

<span class="function">print</span>(f<span class="string">'ë¬¸ì„œë¶„í•  ì™„ë£Œ: {len(doc_chunks)}ê°œ ì²­í¬'</span>)
        </pre>

        <h3>2-2. ì„ë² ë”© ëª¨ë¸ ì¤€ë¹„ ë° VectorDB êµ¬ì¶•</h3>
        <p>BGE-M3ë¥¼ LangChainì˜ `HuggingFaceEmbeddings`ë¡œ ë˜í•‘í•˜ì—¬ VectorDB(ì˜ˆ: Chroma) êµ¬ì¶•ì— ì‚¬ìš©í•©ë‹ˆë‹¤. ë‹¤ì–‘í•œ ëª¨ë¸ì„ ë¹„êµí•˜ê¸° ìœ„í•œ Factory íŒ¨í„´ë„ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <pre>
<span class="keyword">from</span> <span class="variable">langchain_huggingface</span> <span class="keyword">import</span> <span class="function">HuggingFaceEmbeddings</span>
<span class="keyword">from</span> <span class="variable">langchain_chroma</span> <span class="keyword">import</span> <span class="function">Chroma</span>

<span class="comment"># LangChain í˜¸í™˜ BGE-M3 ì„ë² ë”© ì¸ìŠ¤í„´ìŠ¤</span>
<span class="variable">bge_m3_embeddings</span> = <span class="function">HuggingFaceEmbeddings</span>(
    <span class="variable">model_name</span>=<span class="string">'BAAI/bge-m3'</span>, 
    <span class="comment"># ... í•„ìš”í•œ model_kwargs ì„¤ì • ...</span>
)

<span class="comment"># VectorDB êµ¬ì¶• (ì²­í¬ëœ ë¬¸ì„œë¥¼ BGE-M3ë¥¼ ì´ìš©í•´ ì„ë² ë”©)</span>
<span class="variable">vectorStore</span> = <span class="function">Chroma</span>.<span class="function">from_documents</span>(
    <span class="variable">documents</span>=<span class="variable">doc_chunks</span>,
    <span class="variable">collection_name</span>=<span class="string">'korean_docs'</span>,
    <span class="variable">embedding</span>=<span class="variable">bge_m3_embeddings</span>  <span class="comment"># BGE-M3 ì‚¬ìš©</span>
)
        </pre>

        <h3>2-3. ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ê²°ê³¼ í™•ì¸</h3>
        <p>êµ¬ì¶•ëœ VectorDBì— í…ŒìŠ¤íŠ¸ ì§ˆë¬¸ì„ ë˜ì ¸ ê°€ì¥ ìœ ì‚¬í•œ ë¬¸ì„œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. ê²€ìƒ‰ ê²°ê³¼ì˜ ë©”íƒ€ë°ì´í„°(ì˜ˆ: 'topic')ë¥¼ í†µí•´ ì •í™•ë„ë¥¼ ê°„ì ‘ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <pre>
<span class="variable">test_query</span> = <span class="string">"ë”¥ëŸ¬ë‹ì— ê´€í•œ ìµœì‹  ë…¼ë¬¸ ì •ë³´ëŠ”?"</span>
<span class="variable">results</span> = <span class="variable">vectorStore</span>.<span class="function">similarity_search</span>(<span class="variable">test_query</span>)

<span class="function">print</span>(f<span class="string">'ì§ˆë¬¸: {test_query}'</span>)
<span class="function">print</span>(f<span class="string">'ê²€ìƒ‰ê²°ê³¼ í† í”½: {results[0].metadata.get("topic")}'</span>)
<span class="function">print</span>(f<span class="string">'ì°¾ì€ ë¬¸ì¥: {results[0].page_content[:50]}...'</span>)
        </pre>

        <h2>3. ğŸ“Š ì„ë² ë”© ëª¨ë¸ í’ˆì§ˆ í‰ê°€ (Evaluation)</h2>
        <p>ì•„ë¬´ë¦¬ ì¢‹ì€ ëª¨ë¸ì´ë¼ë„ ì‹¤ì œ ë°ì´í„°ì—ì„œ ì œëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ ê²€ì¦í•´ì•¼ í•©ë‹ˆë‹¤. ëª¨ë¸ì´ **ê´€ë ¨ ë¬¸ì„œ**ì™€ **ë¹„ê´€ë ¨ ë¬¸ì„œ**ë¥¼ ì •í™•íˆ êµ¬ë³„í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ê²ƒì´ í‰ê°€ì˜ í•µì‹¬ì…ë‹ˆë‹¤. (íŒŒì¼ 9_2 ë‚´ìš©)</p>

        <h3>í‰ê°€ í•¨ìˆ˜ ë° ë¡œì§</h3>
        <p>í‰ê°€ëŠ” **ì¿¼ë¦¬**ì™€ **ê¸ì • ë¬¸ì„œ(Positive Document, ê´€ë ¨ ë¬¸ì„œ)**ì˜ ìœ ì‚¬ë„ê°€ **ì¿¼ë¦¬**ì™€ **ë¶€ì • ë¬¸ì„œ(Negative Document, ë¹„ê´€ë ¨ ë¬¸ì„œ)**ì˜ ìœ ì‚¬ë„ë³´ë‹¤ ë†’ì€ì§€ í™•ì¸í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.</p>

        <table>
            <thead>
                <tr>
                    <th>í•­ëª©</th>
                    <th>ì„¤ëª…</th>
                    <th>ì„±ê³µ ì¡°ê±´</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>**ê¸ì • ìœ ì‚¬ë„ (Pos_sim)**</td>
                    <td>ì¿¼ë¦¬ vs ê´€ë ¨ ë¬¸ì„œ ìœ ì‚¬ë„</td>
                    <td rowspan="2">**Pos_sim > Neg_sim**</td>
                </tr>
                <tr>
                    <td>**ë¶€ì • ìœ ì‚¬ë„ (Neg_sim)**</td>
                    <td>ì¿¼ë¦¬ vs ë¹„ê´€ë ¨ ë¬¸ì„œ ìœ ì‚¬ë„</td>
                </tr>
            </tbody>
        </table>

        <h3>í‰ê°€ ì½”ë“œ êµ¬ì¡°</h3>
        <pre>
<span class="keyword">def</span> <span class="function">evaluate_embedding_model</span>(<span class="variable">test_pairs</span>, <span class="variable">model</span>):
    <span class="comment"># 1. ì¿¼ë¦¬, ê¸ì • ë¬¸ì„œ, ë¶€ì • ë¬¸ì„œë¥¼ ëª¨ë¸ë¡œ ì„ë² ë”©</span>
    <span class="comment"># ... (ìƒëµ) ...</span>
    
    <span class="variable">results</span> = []
    <span class="variable">correct_count</span> = <span class="number">0</span>
    
    <span class="comment"># 2. ìœ ì‚¬ë„ ê³„ì‚° ë° ë¹„êµ</span>
    <span class="comment"># ...</span>
    <span class="variable">pos_sim</span> = <span class="function">cosine_similarity</span>(<span class="variable">q_emb</span>, <span class="variable">p_emb</span>)
    <span class="variable">neg_sim</span> = <span class="function">cosine_similarity</span>(<span class="variable">q_emb</span>, <span class="variable">n_emb</span>)
        
    <span class="keyword">if</span> <span class="variable">pos_sim</span> > <span class="variable">neg_sim</span>:
        <span class="variable">correct_count</span> += <span class="number">1</span>
        
    <span class="comment"># 3. ì •í™•ë„ ë°˜í™˜</span>
    <span class="keyword">return</span> {<span class="string">'accuracy'</span>: <span class="variable">correct_count</span> / <span class="function">len</span>(<span class="variable">test_pairs</span>), <span class="string">'details'</span>: <span class="variable">results</span>}

<span class="comment"># í•´ì„: ì •í™•ë„ê°€ 90% ì´ìƒì´ë©´ ìš°ìˆ˜í•œ ì„ë² ë”© ëª¨ë¸ë¡œ íŒë‹¨!</span>
        </pre>
    </div>
</body>
</html>