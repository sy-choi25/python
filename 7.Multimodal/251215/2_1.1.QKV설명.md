# ViT Self-Attentionì—ì„œ QKVê°€ ë§Œë“¤ì–´ì§€ëŠ” ê³¼ì • (ì§ê´€ ìš”ì•½)

---

## í•µì‹¬ í•œ ì¤„ (ê°€ì¥ ì¤‘ìš”)

> **LinearëŠ” ê³„ì‚°ì„ ìœ„í•œ ì—°ì‚°ì´ ì•„ë‹ˆë¼,
> í•˜ë‚˜ì˜ í† í° ì˜ë¯¸ë¥¼ â€˜ì—­í• ë³„(Q / K / V)â€™ë¡œ ë‚˜ëˆ„ëŠ” í•„í„°ë‹¤.**

---

## 0ï¸âƒ£ ë¹„ìœ  (ì´í•´ì˜ ì¶œë°œì )

ë¬¸ì¥ì„ ì½ì„ ë•Œ ìš°ë¦¬ëŠ” ë™ì‹œì— ë‹¤ìŒì„ í•œë‹¤:

- ì´ ë‹¨ì–´ê°€ **ë¬´ì—‡ì„ ë§í•˜ëŠ”ì§€** â†’ Value
- ì´ ë‹¨ì–´ê°€ **ì§ˆë¬¸ì— ë§ëŠ”ì§€** â†’ Key
- ì§€ê¸ˆ ë‚´ê°€ **ë¬´ì—‡ì„ ì°¾ê³  ìˆëŠ”ì§€** â†’ Query

ğŸ‘‰ ì´ ì„¸ ê°€ì§€ëŠ” **í•­ìƒ ê°™ì€ ë‹¨ì–´**ì—ì„œ ë‚˜ì˜¨ë‹¤.

---

## 1ï¸âƒ£ ì…ë ¥ xì˜ ì •ì²´

```text
x.shape = [B, N, 768]
```

- B: ë°°ì¹˜ í¬ê¸°
- N: í† í° ìˆ˜ (CLS + íŒ¨ì¹˜)
- 768: embedding_dim (d_model)

ì´ ìƒíƒœì˜ xëŠ”:

> â€œì´ í† í°ì— ëŒ€í•´ ì•Œê³  ìˆëŠ” ëª¨ë“  ì •ë³´ ë©ì–´ë¦¬â€

ì•„ì§:
- Që„ ì•„ë‹ˆê³ 
- Kë„ ì•„ë‹ˆê³ 
- Vë„ ì•„ë‹ˆë‹¤

---

## 2ï¸âƒ£ Linearì˜ ì§„ì§œ ì—­í• 

```python
nn.Linear(768, 768)
```

ì´ê±´ ë‹¨ìˆœ ê³„ì‚°ê¸°ê°€ ì•„ë‹ˆë‹¤.

ì˜ë¯¸:

> **768ì°¨ì› ì˜ë¯¸ë¥¼
> íŠ¹ì • ê´€ì ì—ì„œ ë‹¤ì‹œ í•´ì„í•˜ë¼**

---

## 3ï¸âƒ£ Q, K, Vì˜ ì •ì²´

ê°™ì€ ì…ë ¥ xë¥¼ ì„œë¡œ ë‹¤ë¥¸ ê´€ì ìœ¼ë¡œ ë³¸ë‹¤:

- ì§ˆë¬¸ ê´€ì  â†’ **Q (Query)**
- ë¹„êµ ê¸°ì¤€ ê´€ì  â†’ **K (Key)**
- ì „ë‹¬í•  ì •ë³´ ê´€ì  â†’ **V (Value)**

ğŸ‘‰ ê°™ì€ í† í°, ë‹¤ë¥¸ í•´ì„

---

## 4ï¸âƒ£ ì™œ Linear í•˜ë‚˜ë¡œ QKVë¥¼ ë™ì‹œì— ë§Œë“œë‚˜?

ê°œë…ì ìœ¼ë¡œëŠ”:

```text
Q = Wq @ x
K = Wk @ x
V = Wv @ x
```

í•˜ì§€ë§Œ êµ¬í˜„ì—ì„œëŠ”:

```text
[Wq | Wk | Wv] @ x
```

ê·¸ë˜ì„œ:

```python
nn.Linear(768, 768 * 3)
```

- ê³„ì‚° 1ë²ˆ
- ë©”ëª¨ë¦¬ íš¨ìœ¨
- ì†ë„ ìµœì í™”

---

## 5ï¸âƒ£ ì‹¤ì œ ìˆ«ì íë¦„

### ì…ë ¥ í† í° í•˜ë‚˜

```text
x = [x1, x2, ..., x768]
```

### Linear í†µê³¼ í›„

```text
y = [y1, y2, ..., y2304]
```

ì´ 2304ëŠ” ì‚¬ì‹¤:

```text
[ Q(768) | K(768) | V(768) ]
```

---

## 6ï¸âƒ£ ë¶„ë¦¬ê°€ í•„ìš”í•œ ì´ìœ 

ì½”ë“œì˜ ê´€ì :

> â€œì• 768ì€ Q
> ë‹¤ìŒ 768ì€ K
> ë§ˆì§€ë§‰ 768ì€ Vâ€

ê·¸ë˜ì„œ ë¶„ë¦¬í•œë‹¤.

---

## 7ï¸âƒ£ reshape = ì„œë ì •ë¦¬

```python
qkv.reshape(B, N, 3, heads, head_dim)
```

ì´ê±´ **ê³„ì‚°ì´ ì•„ë‹ˆë‹¤.**

ì˜ë¯¸:

- ì„œë 1: Q
- ì„œë 2: K
- ì„œë 3: V

ê° ì„œë ì•ˆì—ëŠ”:

- heads ê°œìˆ˜ (ì˜ˆ: 12)
- ê° headë‹¹ head_dim (ì˜ˆ: 64)

---

## 8ï¸âƒ£ permute = êº¼ë‚´ ì“°ê¸° ì¢‹ê²Œ ì •ë ¬

```python
qkv.permute(2, 0, 3, 1, 4)
```

ì˜ë¯¸:

> â€œQ, K, Vë¥¼ ë§¨ ì•ìœ¼ë¡œ êº¼ë‚´ìâ€

---

## 9ï¸âƒ£ ìµœì¢… ê²°ê³¼

```python
q, k, v = qkv
```

shape:

```text
[B, heads, N, head_dim]

q.shape == [B, heads, N, head_dim]
k.shape == [B, heads, N, head_dim]
v.shape == [B, heads, N, head_dim]
```

ì´ì œ ê° headë§ˆë‹¤ self-attention ê³„ì‚° ê°€ëŠ¥.

---

## ìµœì¢… ìš”ì•½ ë¬¸ì¥

> **ì…ë ¥ xëŠ” ì˜ë¯¸ ë©ì–´ë¦¬ê³ ,
> LinearëŠ” ê·¸ ì˜ë¯¸ë¥¼
> ì§ˆë¬¸ìš©(Q) / ë¹„êµìš©(K) / ì „ë‹¬ìš©(V)ìœ¼ë¡œ ë‚˜ëˆ ì„œ
> Self-Attentionì´ ê°€ëŠ¥í•˜ê²Œ ë§Œë“ ë‹¤.**

